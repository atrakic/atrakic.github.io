general:
#  branches:
#    only:
#    - master # list of branches to build
#    - /feature-.*/ # or regexes

machine:
  ruby:
    version: 2.4.0
  services:
    - docker
  environment:
    NOKOGIRI_USE_SYSTEM_LIBRARIES: true # speeds up installation of html-proofer
    USER_NAME: atrakic

dependencies:
  pre:
    - docker info
    - bundle exec jekyll build
    - ./bin/setup
#  override:
    - docker build --rm=false -t xomodo/atrakic.github.io:$CIRCLE_SHA1 .

test:
  post:
    - bundle exec htmlproofer ./_site --allow-hash-href --check-favicon --check-html --disable-external
    - docker run -d -p 4000:4000 xomodo/atrakic.github.io:$CIRCLE_SHA1; sleep 10
    - curl --retry 10 --retry-delay 5 -v http://localhost:4000
